<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Functional Reactive Actors in F#</title>

  <meta name="author" content="YJ Park" />

  

  <meta name="generator" content="Hugo 0.32.4" />

  <link rel="alternate" href="/index.xml" type="application/rss+xml" title="Living and Programming - YJ Park&#39;s Blog">

  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="/css/rouge.css" />

  <link rel="stylesheet" href="/css/paper-canvas.css" />

  
  <meta property="og:title" content="Functional Reactive Actors in F#" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/blog/2017/08/12/functional-reactive-actors-in-fsharp//" />
  <meta property="og:image" content="img/yjpark_icon.png" />

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Living and Programming - YJ Park&#39;s Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
          <a title="Blog" href="/">Blog</a>
  	      </li>
  	    
      
        
          <li>
          <a title="About" href="/page/about/">About</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
          <a title="Living and Programming - YJ Park&#39;s Blog" href="/">
              <img class="avatar-img" src="/img/yjpark_icon.png" alt="Living and Programming - YJ Park&#39;s Blog" />
          </a>
      
	  </div>
	</div>

  </div>
</nav>

    <canvas id="paper-background" resize></canvas>

    <div role="main" class="container main-content">

      
        <header class="header-post">
  <div class="row">
    <div class="col-lg-11 col-lg-offset-1 col-md-11 col-md-offset-1">
      <div class="post-heading">
        <h1>Functional Reactive Actors in F#</h1>
        
        <span class="post-meta">Posted on August 12, 2017</span>
      </div>
     </div>
  </div>
</header>

<article>
  <div class="row">
    <div class="col-lg-11 col-lg-offset-1 col-md-11 col-md-offset-1">
	  <p>In the last few months, I&rsquo;ve created an actor frameworks in which each actors is in functional reactive way in F#.</p>

<p>Basically each actor is created with the Elm Architecture, everything is strong typed, can be run on Dot Net Core, or in browser with javascript generated by Fable, also can be run on mobile or desktop devices with Xamarin or Dot Net.</p>

<p>It costed me much time and efforts to get it to current state, learned a lot along the way, will try to write something before I forget the details.</p>

<p></p>

<h2 id="some-background-feel-free-to-skip">Some Background (Feel Free to Skip)</h2>

<p>Back in March, I started a new projects that needs server side logic and web or native apps as clients.</p>

<p>My first attempt was to tweak the server side framework that I used on games before for it. It was my dap context in C# running on top of Orleans actor framework. Orleans works purely in async way as an actor system, though my libs was originally used in games, and was mainly in sync mode, so I ended us have some hacky solution to mix them together, in the game usage it seems to be fine, didn&rsquo;t caused me much problems. Though the new project involves many external HTTP and WebSocket access, so the framework gets in the way, may the code messy with some nasty delay to link sync and async sides together.</p>

<p>Also there are quite some complex data structures in it as well, I tried to use the metadata code generator (use Microsoft Bond as data definition language) I created for game dev with it as well, though not really happy either, for games&rsquo; metadata, there are a few rather complex data structures that may have many instances, and the data type itself usually are combined by simple types. Though in the new project, the logic is quite complex, and the number of data structure is quite big, it&rsquo;s very annoying if I want to create Bond definitions for everything.</p>

<p>So after a couple of week patching the exist framework, and fighting with some nasty bugs with the patching, and need more patchs on top of it, I decided to take a new approach.</p>

<p>At first, I planned to take full Orleans approach, the problem was that being an (virtual) actor framework, I still need to find my way to organize these actors together in a nice way. Also being a server-side framework, it can not really help for the client side, though I really don&rsquo;t want 2 languages if possible.</p>

<p>So it become clear that I need some framework again, pure async one to work nicely with Orleans and GUI apps, easy to access external services through HTTP and WebSocket, single language for both client and server side.</p>

<h2 id="why-f">Why F#</h2>

<p>I did use Elm in some front-end small projects in last couple of years, which is great, use Records and Unions can describe data structures very nicely, and refactoring with Elm feels so good. Though server-side Elm is missing ATM, did some hacky way to render HTML pages with it running in node, though it&rsquo;s not ready for heavy logic yet.</p>

<p>I also did some experiments with Purescript before, which is very similar to Haskell, transcompiled to javascript, so can be run on browsers, nodejs, and react-native. The language is well-designed, harder to learn compared to Elm. Seems Purescript is even less popular than Elm, so it might be a risky choice, also running the backend on nodejs is not ideal to me.</p>

<p>Dot Not Core is really nice, Orleans is very nice too, I really want to keep work on top of them, so I did the framework in F# eventually.</p>

<p>I&rsquo;ve been reading on F# before, which seems a compromised design back then, it&rsquo;s not a pure function language, support complete Object-Oriented as well, also can use mutable values if you wanted to. on the other hand, these design choices make it quite practical, and can took advantage of the much bigger C# libraries when need to integrate with third-parties.</p>

<p>Fable is a transcompiler for F# to generate javascript codes, then it can be run in browser or react native apps. It&rsquo;s quite nice, there are certain limitations and some small things to be considered, but after the development environment been setup properly, it works as expected.</p>

<p>Another bonus to me is that I am used to generics in C#, generics in F# is as powerful, and actual codes can be much shorter.</p>

<h2 id="elmish-functional-reactive-in-f">Elmish (Functional Reactive in F#)</h2>

<p>The Elm Architecture is really nice way to write logic, the idea is that you describe type of model and message, the running is just a serious of messages received and versions of models according to these messages.</p>

<p>In ideal situation the model should be immutable, then it&rsquo;s quite easy to get serialized, which can leads to powerful features such as persistent app states, and time travel debugger.</p>

<p>F# community had created similar approach as Elmish, which is quite simple actually, was created to be used in Fable, then refactored to be used in normal F# as well.</p>

<p>The essential idea is that logic will check incoming message, create a new model based on the current one, any might create new messages that will be send into itself later. Of course it&rsquo;s much more complex in real world usage, though technically it&rsquo;s mostly about how an update is implemented, the method signature looks like this:</p>

<pre><code class="language-F#">type Update&lt;'model, 'msg&gt; = 'msg -&gt; 'model -&gt; 'model * Cmd&lt;'msg&gt;
</code></pre>

<h2 id="actors-and-runtime">Actors and Runtime</h2>

<p>The Elmish approach did imply an actor like way, messages can be received one-by-one, and sending messages should be the only way to interact with the inner system, which is basically an actor.</p>

<p>In Elm&rsquo;s cases, the whole application is the only actor, use subscriptions and system libraries (such as HTTP accessing) to generate messages that send back in the future.</p>

<p>Elmish provide simple implementation with F#&rsquo;s MailboxProcessor, you can create multiple programs if you want, it provide view rendering to show stuffs in browsers (or react native, or other GUI system such as Xamarin Forms). It&rsquo;s also usually the only actor.</p>

<p>On the contrary, actor framework normally have many actors, and usually not having GUI elements with them.</p>

<p>My tasks here is to create a runtime for my actors. which will handle the message passing, and state management, also optional GUI integration.</p>

<p>I did some abstraction with the runtime, so it&rsquo;s implementation can be on top of different platforms, currently I&rsquo;ve have one with MailboxProcessor, later will add Orleans and maybe experiment with ProtoActor later.</p>

<p>Also did some abstraction with the runner object, so I can organize actor-specific helpers easily, e.g. one actor might want to access or create other actors, one way is to make this a system wise singleton, though that means it&rsquo;s not easy to isolate actors from each other. another example is loggers, I want each actor to have its own logger, so the code need someway to access the logger.</p>

<p>So my update looks like:</p>

<pre><code class="language-F#">type Update&lt;'runner, 'model, 'msg&gt; =
    'runner -&gt; 'msg -&gt; 'model -&gt; 'model * Cmd&lt;'msg&gt;
</code></pre>

<p>This is the biggest difference between my framework and Elmish, also this make the implementation much harder, I feel it worth the effort, will have more details on this topic later.</p>

<h2 id="where-is-the-code">Where is The Code?</h2>

<p>It&rsquo;s not ready yet, it&rsquo;s working, can be used as nuget packages (on private source now), though not yet ready to be open-sourced, currently still in the quick iteration mode.</p>

<p>Will write more blogs first, then when it&rsquo;s stable enough, will probably make it public.</p>
	</div>
  </div>
</article>

<div class="row">
    <div class="col-lg-11 col-lg-offset-1 col-md-11 col-md-offset-1">
    <ul class="pager blog-pager">
      
      <li class="previous">
        <a href="/blog/2017/01/07/introduction-to-dap-context/" data-toggle="tooltip" data-placement="top" title="Introduction to Dap Context">&larr; Previous Post</a>
      </li>
      
      
    </ul>
  </div>
</div>


<div class="row disqus-comments">
  <div class="col-lg-11 col-lg-offset-1 col-md-11 col-md-offset-1">
    <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yjpark" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</div>


      

    </div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/yjpark" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
          <li>
            <a href="https://twitter.com/yjpark" title="Twitter">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
          <li>
            <a href="mailto:yjpark@gmail.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
	    	  

    		  <li>
      			<a href="/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>

        </ul>
        <p class="copyright text-muted">
    		  YJ Park
    		  &nbsp;&bull;&nbsp;
    		  2017

    		  
    		  &nbsp;&bull;&nbsp;
    		  <a href="/">Living and Programming - YJ Park&#39;s Blog</a>
    		  
  	    </p>
  	        
    		<p class="theme-by text-muted">
    		  Theme based on
    		  <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
    		</p>
      </div>
    </div>
  </div>
</footer>

<script src="/js/jquery-1.11.2.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>

<script src="/js/paper-full.min.js"></script>
<script type="text/paperscript" src="js/paper-sea.js" canvas="paper-background">
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-2120845-8', 'auto');
ga('send', 'pageview');
</script>



  </body>
</html>
