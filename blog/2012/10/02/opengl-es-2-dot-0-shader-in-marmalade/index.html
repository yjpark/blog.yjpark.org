
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>OpenGL ES 2.0 Shader in Marmalade - Living and Programming - YJ Park's Blog</title>
  <meta name="author" content="YJ Park">

  
  <meta name="description" content="Marmalade provide good support for writing custom shaders in it, though it&#8217;s not easy to get all the information to start writing the first &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.yjpark.org/blog/2012/10/02/opengl-es-2-dot-0-shader-in-marmalade">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/yjpark" rel="alternate" title="Living and Programming - YJ Park's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2120845-8']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Living and Programming - YJ Park's Blog</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/yjpark" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.yjpark.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">OpenGL ES 2.0 Shader in Marmalade</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-02T18:00:00+08:00" pubdate data-updated="true">2012-10-02 18:00</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Marmalade provide good support for writing custom shaders in it, though it&#8217;s not easy to get all the information to start writing the first shader in my case, here is some information that I gathered during the process.</p>

<p>I decided to only support Open GL 2.0 Shaders in our games, most current devices support it, and as a small team, supporting older devices is a bit hard since we don&#8217;t have testers for now, also the architect of 2.0 is simpler and cleaner.</p>

<p>The sample shader&#8217;s function is to replace non-transparent part of the image to a given color, then the color can be changed programmingly (also by xml thanks to IwGame). Basically the images will be just working as masks, the actually color to be rendered are controlled by the shader.</p>

<p>I will not cover the basics about Open GL Shaders, there are plenty of information on the web about that, also a PDF doc is included in Marmalade installation, it&#8217;s a good start point to me, you should read it first to get the concepts.</p>

<!-- more -->


<h2>Marmalade Rendering with Custom Shader</h2>

<p>Marmalade support shader very well by the <a href="http://docs.madewithmarmalade.com/native/api_reference/api/classCIwGxShaderTechnique.html">CIwGxShaderTechnique</a> class, to use it, you need to set it to material, here is the snnipet for that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">CIwMaterial</span><span class="o">*</span> <span class="n">mat</span> <span class="o">=</span> <span class="n">IW_GX_ALLOC_MATERIAL</span><span class="p">();</span>
</span><span class='line'><span class="n">mat</span><span class="o">-&gt;</span><span class="n">SetTexture</span><span class="p">(</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">getImage2D</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetMaterial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTexture</span><span class="p">());</span>
</span><span class='line'><span class="n">mat</span><span class="o">-&gt;</span><span class="n">SetShaderTechnique</span><span class="p">(</span><span class="n">shader</span><span class="p">);</span>
</span><span class='line'><span class="n">IwGxSetMaterial</span><span class="p">(</span><span class="n">mat</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The shader here is a pointer to CIwGxShaderTechnique, and the image is a pointer to CIwGameImage (part of IwGame), if you are not using IwGame, you can use Iw2d, or IwGx directly.</p>

<p>The following function can load a shader from a resource group.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">CIwGxShaderTechnique</span><span class="o">*</span> <span class="n">getShader</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">shaderName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">CIwGxShaderTechnique</span><span class="o">*</span> <span class="n">shaderTemplate</span> <span class="o">=</span> <span class="p">(</span><span class="n">CIwGxShaderTechnique</span><span class="o">*</span><span class="p">)</span><span class="n">IwGetResManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetResNamed</span><span class="p">(</span><span class="n">shaderName</span><span class="p">,</span> <span class="s">&quot;CIwGxShaderTechnique&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">shaderTemplate</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">shader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CIwGxShaderTechnique</span><span class="p">();</span>
</span><span class='line'>    <span class="n">IwSerialiseOpen</span><span class="p">(</span><span class="s">&quot;shader-Duplicate.bin&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>    <span class="n">shaderTemplate</span><span class="o">-&gt;</span><span class="n">Serialise</span><span class="p">();</span>
</span><span class='line'>    <span class="n">IwSerialiseClose</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">IwSerialiseOpen</span><span class="p">(</span><span class="s">&quot;shader-Duplicate.bin&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>    <span class="n">shader</span><span class="o">-&gt;</span><span class="n">Serialise</span><span class="p">();</span>
</span><span class='line'>    <span class="n">IwSerialiseClose</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">shader</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note: since I need multiple instance of the shader for diffrent images with differnt colors, here I use a quick solution with marmalade&#8217;s serialization, which is NOT thread safe due to the hard code file name.</p>

<p>Load the resource group as this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">IwGetResManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">LoadGroup</span><span class="p">(</span><span class="s">&quot;effect/Shaders.group&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Files Used</h2>

<p>You need to include the shader files in the asset section of the mkb/mkf file, like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">files</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">Data</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">effect</span><span class="o">/</span><span class="n">Shaders</span><span class="p">.</span><span class="n">group</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">assets</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="n">ram</span><span class="o">/</span><span class="n">data</span><span class="o">-</span><span class="n">gles1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">effect</span><span class="o">/</span><span class="n">Shaders</span><span class="p">.</span><span class="n">group</span><span class="p">.</span><span class="n">bin</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please refer to Marmalade&#8217;s documents if you are not familiar with the resource compiling process and mkb syntaxes.</p>

<p>Here is data/effect/Shaders.group</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">CIwResGroup</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">name</span> <span class="s">&quot;PettyFun Environment Shaders&quot;</span>
</span><span class='line'>    <span class="n">shared</span> <span class="kc">true</span>
</span><span class='line'>
</span><span class='line'>    <span class="s">&quot;./PfMaskEffectShader.itx&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The content of data/effect/PfMaskEffectShader.itx</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">CIwGxShaderTechnique</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">name</span> <span class="s">&quot;PfMaskEffectShader&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">param</span> <span class="s">&quot;p_Color&quot;</span> <span class="n">vec4</span> <span class="mi">1</span> <span class="p">{</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">shader</span> <span class="s">&quot;vertex&quot;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">attribute</span> <span class="n">highp</span> <span class="n">vec4</span> <span class="n">inVert</span><span class="p">;</span>
</span><span class='line'>        <span class="n">attribute</span> <span class="n">mediump</span> <span class="n">vec2</span> <span class="n">inUV0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">uniform</span> <span class="n">highp</span> <span class="n">mat4</span> <span class="n">inPMVMat</span><span class="p">;</span>
</span><span class='line'>        <span class="n">uniform</span> <span class="n">mediump</span> <span class="n">vec2</span> <span class="n">inUVOffset</span><span class="p">;</span>
</span><span class='line'>        <span class="n">uniform</span> <span class="n">mediump</span> <span class="n">vec2</span> <span class="n">inUVScale</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">varying</span> <span class="n">mediump</span> <span class="n">vec2</span> <span class="n">v_UV0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">void</span> <span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">gl_Position</span> <span class="o">=</span> <span class="n">inPMVMat</span> <span class="o">*</span> <span class="n">inVert</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">v_UV0</span> <span class="o">=</span> <span class="n">inUV0</span> <span class="o">*</span> <span class="n">inUVScale</span> <span class="o">+</span> <span class="n">inUVOffset</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">shader</span> <span class="s">&quot;fragment&quot;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">uniform</span> <span class="n">sampler2D</span> <span class="n">inSampler0</span><span class="p">;</span>
</span><span class='line'>        <span class="n">varying</span> <span class="n">mediump</span> <span class="n">vec2</span> <span class="n">v_UV0</span><span class="p">;</span>
</span><span class='line'>        <span class="n">uniform</span> <span class="n">mediump</span> <span class="n">vec4</span> <span class="n">p_Color</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">void</span> <span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">mediump</span> <span class="n">vec4</span> <span class="n">c</span> <span class="o">=</span> <span class="n">texture2D</span><span class="p">(</span><span class="n">inSampler0</span><span class="p">,</span> <span class="n">v_UV0</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="n">vec4</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="n">p_Color</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please read <a href="http://docs.madewithmarmalade.com/native/api_reference/api/group__IwGxShaderTechnique.html">IwGxShaderTechnique Reference</a> for the list of the attributes that you can use. It took me quite a while to find this document since this is no links to this page on the class reference page. This is VERY useful for writing shaders in Marmalade.</p>

<h2>Update Params By Code and XML</h2>

<p>the <strong>param</strong> in the shader is for the parameters from your code, change it&#8217;s value like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">void</span> <span class="n">PfShaderEffect</span><span class="o">::</span><span class="n">SetShaderParam</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">paramName</span><span class="p">,</span> <span class="n">CIwGxShaderUniform</span><span class="o">::</span><span class="n">CIwGxShaderUniformType</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">Shader</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CIwGxShaderUniform</span><span class="o">*</span> <span class="n">param</span> <span class="o">=</span> <span class="n">Shader</span><span class="o">-&gt;</span><span class="n">GetParam</span><span class="p">(</span><span class="n">paramName</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span> <span class="n">param</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">param</span><span class="o">-&gt;</span><span class="n">Set</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">PfTrace</span><span class="p">(</span><span class="s">&quot;Shader Param Not Exist: %s&quot;</span><span class="p">,</span> <span class="n">paramName</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">PfShaderEffect</span><span class="o">::</span><span class="n">SetShaderParamAsInt</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">paramName</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SetShaderParam</span><span class="p">(</span><span class="n">paramName</span><span class="p">,</span> <span class="n">CIwGxShaderUniform</span><span class="o">::</span><span class="n">INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">PfShaderEffect</span><span class="o">::</span><span class="n">SetShaderParamAsFloat</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">paramName</span><span class="p">,</span> <span class="kt">float</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SetShaderParam</span><span class="p">(</span><span class="n">paramName</span><span class="p">,</span> <span class="n">CIwGxShaderUniform</span><span class="o">::</span><span class="n">FLOAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">PfShaderEffect</span><span class="o">::</span><span class="n">SetShaderParamAsColor</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">paramName</span><span class="p">,</span> <span class="n">CIwColour</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">float</span> <span class="n">color</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span><span class='line'>    <span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">*</span> <span class="n">value</span><span class="p">.</span><span class="n">r</span> <span class="o">/</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>    <span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">*</span> <span class="n">value</span><span class="p">.</span><span class="n">g</span> <span class="o">/</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>    <span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">*</span> <span class="n">value</span><span class="p">.</span><span class="n">b</span> <span class="o">/</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>    <span class="n">color</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">*</span> <span class="n">value</span><span class="p">.</span><span class="n">a</span> <span class="o">/</span> <span class="mh">0xff</span><span class="p">;</span>
</span><span class='line'>    <span class="n">SetShaderParam</span><span class="p">(</span><span class="n">paramName</span><span class="p">,</span> <span class="n">CIwGxShaderUniform</span><span class="o">::</span><span class="n">VEC4</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">PfShaderEffect</span><span class="o">::</span><span class="n">UpdateColorFromAnimation</span><span class="p">(</span><span class="n">CIwColour</span><span class="o">*</span> <span class="n">color</span><span class="p">,</span> <span class="n">CIwGameAnimInstance</span> <span class="o">*</span><span class="n">animation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">CIwGameAnimFrameVec4</span><span class="o">*</span> <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">CIwGameAnimFrameVec4</span><span class="o">*</span><span class="p">)</span><span class="n">animation</span><span class="o">-&gt;</span><span class="n">getCurrentData</span><span class="p">();</span>
</span><span class='line'>    <span class="n">color</span><span class="o">-&gt;</span><span class="n">r</span> <span class="o">=</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>    <span class="n">color</span><span class="o">-&gt;</span><span class="n">g</span> <span class="o">=</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>    <span class="n">color</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">=</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
</span><span class='line'>    <span class="n">color</span><span class="o">-&gt;</span><span class="n">a</span> <span class="o">=</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since I&#8217;m using IwGame, it&#8217;s very easy to make the color controlled by the XOML animation, all I need to do is to override the UpdateFromAnimation method of CIwGameActor, and handle the color value from it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="kt">bool</span> <span class="n">PfMaskEffect</span><span class="o">::</span><span class="n">UpdateFromAnimation</span><span class="p">(</span><span class="n">CIwGameAnimInstance</span> <span class="o">*</span><span class="n">animation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">PfShaderEffect</span><span class="o">::</span><span class="n">UpdateFromAnimation</span><span class="p">(</span><span class="n">animation</span><span class="p">))</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">bool</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">animation</span><span class="o">-&gt;</span><span class="n">isDelta</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">element_name</span> <span class="o">=</span> <span class="n">animation</span><span class="o">-&gt;</span><span class="n">getTargetPropertyHash</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">element_name</span> <span class="o">==</span> <span class="n">PfHash</span><span class="p">(</span><span class="s">&quot;Color&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">UpdateColorFromAnimation</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Color</span><span class="p">,</span> <span class="n">animation</span><span class="p">);</span>
</span><span class='line'>        <span class="n">SetShaderParamAsColor</span><span class="p">(</span><span class="s">&quot;p_Color&quot;</span><span class="p">,</span> <span class="n">Color</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you can generate smooth color switch animation by pure XML as normal IwGame Animation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Template</span> <span class="na">Name=</span><span class="s">&quot;MaskColorTimelineTemplate&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Animation</span> <span class="na">Name=</span><span class="s">&quot;MaskColorAnim$name$&quot;</span> <span class="na">Duration=</span><span class="s">&quot;$duration$&quot;</span> <span class="na">Type=</span><span class="s">&quot;vec4&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Frame</span> <span class="na">Value=</span><span class="s">&quot;$startcolor$&quot;</span> <span class="na">Time=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Frame</span> <span class="na">Value=</span><span class="s">&quot;$endcolor$&quot;</span> <span class="na">Time=</span><span class="s">&quot;$duration$&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Animation&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Timeline</span> <span class="na">Name=</span><span class="s">&quot;MaskColorTimeline$name$&quot;</span> <span class="na">AutoPlay=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Animation</span> <span class="na">Anim=</span><span class="s">&quot;MaskColorAnim$name$&quot;</span> <span class="na">Target=</span><span class="s">&quot;Color&quot;</span> <span class="na">Repeat=</span><span class="s">&quot;1&quot;</span> <span class="na">StartAtTime=</span><span class="s">&quot;0&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Timeline&gt;</span>
</span><span class='line'><span class="nt">&lt;/Template&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;Actor</span> <span class="err">...</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;FromTemplate</span> <span class="na">Template=</span><span class="s">&quot;MaskColorTimelineTemplate&quot;</span> <span class="na">name=</span><span class="s">&quot;ColorChange&quot;</span> <span class="na">duration=</span><span class="s">&quot;2&quot;</span>
</span><span class='line'>        <span class="na">startcolor=</span><span class="s">&quot;180, 220, 251, 255&quot;</span> <span class="na">endcolor=</span><span class="s">&quot;255, 0, 0, 255&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/Actor&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is very flexible and powerful, no need to recompile, just updating plain XML files.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">YJ Park</span></span>

      








  


<time datetime="2012-10-02T18:00:00+08:00" pubdate data-updated="true">2012-10-02 18:00</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/iwgame/'>iwgame</a>, <a class='category' href='/blog/categories/marmalade/'>marmalade</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.yjpark.org/blog/2012/10/02/opengl-es-2-dot-0-shader-in-marmalade/" data-via="yjpark" data-counturl="http://blog.yjpark.org/blog/2012/10/02/opengl-es-2-dot-0-shader-in-marmalade/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/08/30/game-engine-based-on-marmalade-and-iwgame/" title="Previous Post: Game Engine Based on Marmalade and IwGame">&laquo; Game Engine Based on Marmalade and IwGame</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/10/12/level-editor-based-on-iwgame-introduction/" title="Next Post: Level Editor Based on IwGame - Introduction">Level Editor Based on IwGame - Introduction &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Tag Cloud</h1>
    <span id="tag-cloud"><a href='/blog/categories/chinese' style='font-size: 115.0%'>chinese(1)</a> <a href='/blog/categories/code' style='font-size: 160.0%'>code(4)</a> <a href='/blog/categories/game' style='font-size: 115.0%'>game(1)</a> <a href='/blog/categories/ios' style='font-size: 115.0%'>ios(1)</a> <a href='/blog/categories/iwgame' style='font-size: 145.0%'>iwgame(3)</a> <a href='/blog/categories/marmalade' style='font-size: 160.0%'>marmalade(4)</a> <a href='/blog/categories/movablewrite' style='font-size: 115.0%'>movablewrite(1)</a> <a href='/blog/categories/pettyfun' style='font-size: 145.0%'>pettyfun(3)</a> <a href='/blog/categories/pfgame' style='font-size: 145.0%'>pfgame(3)</a> <a href='/blog/categories/tool' style='font-size: 115.0%'>tool(1)</a> </span>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/04/14/marmalade-tricks-and-tips/">Marmalade Tricks and Tips</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/06/initial-release-of-s3ebass-marmalade-extension-for-bass-audio-engine/">Initial Release of s3eBass - Marmalade extension for BASS audio engine</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/05/convert-cocos2d-font-bmfont-to-marmalades-gxfont/">Convert Cocos2D Font (BMFont) to Marmalade's GxFont</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/12/level-editor-based-on-iwgame-introduction/">Level Editor Based on IwGame - Introduction</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/02/opengl-es-2-dot-0-shader-in-marmalade/">OpenGL ES 2.0 Shader in Marmalade</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/yjpark">@yjpark</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'yjpark',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("yjpark", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/yjpark" class="twitter-follow-button" data-show-count="false">Follow @yjpark</a>
  
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - YJ Park -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'yjpark';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.yjpark.org/blog/2012/10/02/opengl-es-2-dot-0-shader-in-marmalade/';
        var disqus_url = 'http://blog.yjpark.org/blog/2012/10/02/opengl-es-2-dot-0-shader-in-marmalade/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
